<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Control de Asistencia - 8 D√≠as</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f5f7fb; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  .container { max-width:1000px; margin:24px auto; }
  header { background:#0d6efd; color:#fff; padding:12px 16px; border-radius:8px; margin-bottom:12px; }
  .card { border-radius:8px; }
  .small-note{font-size:.875rem;color:#666}
  .btn-ghost { background:transparent; border:1px solid #ddd; }
  table { font-size:.9rem; }
  .mono { font-family: monospace; }
</style>
</head>
<body>
<div class="container">
  <header class="d-flex justify-content-between align-items-center">
    <div><strong>üìã Control de Asistencia ‚Äî 8 D√≠as</strong></div>
    <div class="small-note">Admin: <span class="mono">admin</span> / <span class="mono">1234</span></div>
  </header>

  <!-- LOGIN -->
  <div id="loginCard" class="card p-3 mb-3">
    <h5>Iniciar sesi√≥n</h5>
    <div class="row g-2">
      <div class="col-md-6"><input id="loginUser" class="form-control" placeholder="Usuario" autocomplete="username"></div>
      <div class="col-md-6"><input id="loginPass" type="password" class="form-control" placeholder="Contrase√±a" autocomplete="current-password"></div>
    </div>
    <div class="mt-2 d-flex gap-2">
      <button id="btnLogin" class="btn btn-primary">Entrar</button>
      <button id="btnOpenAdmin" class="btn btn-outline-secondary">Admin (panel)</button>
      <button id="btnReset" class="btn btn-outline-danger">Borrar datos locales</button>
    </div>
    <div class="mt-2 small-note">Si eres administrador usa <code>admin</code>/<code>1234</code>. S√≥lo el admin puede crear usuarios.</div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="card p-3 mb-3" style="display:none">
    <h5>Panel administrador</h5>
    <div class="row g-2">
      <div class="col-md-5"><input id="newUser" class="form-control" placeholder="Nuevo usuario"></div>
      <div class="col-md-5"><input id="newPass" type="password" class="form-control" placeholder="Contrase√±a"></div>
      <div class="col-md-2"><button id="btnCreateUser" class="btn btn-primary w-100">Crear</button></div>
    </div>
    <div class="mt-3" id="usersList"></div>
    <div class="mt-3 small-note">El admin no puede ser eliminado. Los usuarios y datos se guardan localmente en este dispositivo.</div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="card p-3" style="display:none">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div>
        <div>Sesi√≥n: <strong id="who"></strong></div>
        <div class="small-note">Solo usuarios registrados pueden capturar asistencia.</div>
      </div>
      <div class="text-end">
        <button id="btnLogout" class="btn btn-sm btn-ghost">Cerrar sesi√≥n</button>
      </div>
    </div>

    <!-- Configure dates -->
    <div class="mb-3">
      <label class="form-label">Fecha de inicio (d√≠a 1)</label>
      <div class="row g-2">
        <div class="col-md-6"><input id="startDate" type="date" class="form-control"></div>
        <div class="col-md-6 d-flex gap-2">
          <input id="counterInit" type="number" min="0" class="form-control" value="0" placeholder="Contador inicial">
          <button id="btnGenerate" class="btn btn-primary">Generar 8 d√≠as</button>
        </div>
      </div>
      <div class="mt-2 small-note">Se generar√°n 8 fechas consecutivas a partir de la seleccionada (sin ajustes de zona horaria).</div>
    </div>

    <!-- Register -->
    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <label>D√≠a</label>
        <select id="daySelect" class="form-select"><option value="">-- Genera las fechas --</option></select>
      </div>
      <div class="col-md-4">
        <label>Nombre</label>
        <select id="attName" class="form-select">
          <option value="">-- Selecciona o escribe nombre --</option>
        </select>
      </div>
      <div class="col-md-2"><label>Grupo</label><input id="attGroup" class="form-control"></div>
      <div class="col-md-2"><label>Tel√©fono</label><input id="attPhone" class="form-control" inputmode="tel"></div>
    </div>
    <div class="d-flex gap-2 mb-3">
      <button id="btnAdd" class="btn btn-success">Agregar registro</button>
      <button id="btnClear" class="btn btn-outline-secondary">Limpiar</button>
      <button id="btnExportXLS" class="btn btn-outline-success">Exportar Excel</button>
      <button id="btnExportPDF" class="btn btn-outline-primary">Exportar PDF</button>
      <button id="btnFinal" class="btn btn-info">üìä Reporte final de asistencia</button>
    </div>

    <!-- Overview -->
    <div id="overview" class="mb-3">
      <h6>Vista r√°pida (8 d√≠as)</h6>
      <div id="daysGrid" class="row g-2"></div>
    </div>

    <!-- Final report area -->
    <div id="finalReportArea" class="mt-3"></div>
  </div>

  <footer class="text-center small-note mt-4">Consejo: agrega a pantalla de inicio en tu celular para usar como app</footer>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
const KEY = 'asistencia_app_v3';
const DEFAULT_STORE = { users: { admin: '1234' }, startDate: null, counter: 0, dates: [], records: [] };

function loadStore(){ try{ const raw = localStorage.getItem(KEY); if(!raw){ localStorage.setItem(KEY, JSON.stringify(DEFAULT_STORE)); return JSON.parse(JSON.stringify(DEFAULT_STORE)); } return JSON.parse(raw); } catch(e){ localStorage.setItem(KEY, JSON.stringify(DEFAULT_STORE)); return JSON.parse(JSON.stringify(DEFAULT_STORE)); } }
function saveStore(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

let store = loadStore();
let currentUser = null;

const loginCard = document.getElementById('loginCard');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const btnOpenAdmin = document.getElementById('btnOpenAdmin');
const btnReset = document.getElementById('btnReset');

const adminPanel = document.getElementById('adminPanel');
const newUserEl = document.getElementById('newUser');
const newPassEl = document.getElementById('newPass');
const btnCreateUser = document.getElementById('btnCreateUser');
const usersList = document.getElementById('usersList');

const appCard = document.getElementById('app');
const whoEl = document.getElementById('who');
const btnLogout = document.getElementById('btnLogout');

const startDateEl = document.getElementById('startDate');
const btnGenerate = document.getElementById('btnGenerate');
const counterInit = document.getElementById('counterInit');
const daySelect = document.getElementById('daySelect');
const btnAdd = document.getElementById('btnAdd');
const btnClear = document.getElementById('btnClear');
const attName = document.getElementById('attName');
const attGroup = document.getElementById('attGroup');
const attPhone = document.getElementById('attPhone');
const daysGrid = document.getElementById('daysGrid');

const btnExportXLS = document.getElementById('btnExportXLS');
const btnExportPDF = document.getElementById('btnExportPDF');
const btnFinal = document.getElementById('btnFinal');
const finalReportArea = document.getElementById('finalReportArea');

function initUI(){
  store = loadStore();
  counterInit.value = store.counter || 0;
  if(store.startDate) startDateEl.value = store.startDate;
  if(store.dates && store.dates.length===8) {
    buildDaySelect(store.dates);
    renderDaysOverview();
  } else { daySelect.innerHTML = '<option value="">-- Genera las fechas --</option>'; }
  renderUsersList();
}
initUI
